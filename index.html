<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>San Pio X Plataforma Escolar</title>
    <style>
        :root {
            --color-primario: #0d47a1;
            --color-secundario: #1976d2;
            --color-fondo: #e3f2fd;
            --color-texto: #333;
            --color-blanco: #ffffff;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: var(--color-fondo);
            color: var(--color-texto);
        }

        /* Pantalla de acceso */
        #pantalla-acceso {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .acceso-card {
            background: var(--color-blanco);
            padding: 20px;
            border-radius: 10px;
            max-width: 380px;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .acceso-card h1 {
            margin-top: 0;
            color: var(--color-primario);
            font-size: 1.4rem;
        }
        .acceso-card p {
            font-size: 0.9rem;
            color: #555;
        }
        .acceso-group {
            margin-top: 15px;
            font-size: 0.9rem;
        }
        .acceso-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
        }
        .acceso-opciones {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }
        .acceso-opciones label {
            font-weight: normal;
        }
        .acceso-input {
            width: 100%;
            padding: 8px;
            font-size: 0.9rem;
            border-radius: 4px;
            border: 1px solid #bbb;
        }
        .acceso-boton {
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: var(--color-primario);
            color: var(--color-blanco);
            font-size: 0.95rem;
            cursor: pointer;
        }
        .acceso-boton:hover {
            background: var(--color-secundario);
        }
        .acceso-error {
            margin-top: 8px;
            color: #b71c1c;
            font-size: 0.8rem;
            min-height: 16px;
        }
        .acceso-ver-clave {
            margin-top: 5px;
            font-size: 0.8rem;
        }

        header {
            background: linear-gradient(135deg, var(--color-primario), var(--color-secundario));
            color: var(--color-blanco);
            padding: 20px;
            text-align: center;
        }
        header h1 {
            margin: 0;
            font-size: 1.8rem;
        }
        header p {
            margin: 5px 0 0;
            font-size: 0.9rem;
        }
        nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            background: var(--color-primario);
        }
        nav a {
            color: var(--color-blanco);
            padding: 10px 14px;
            text-decoration: none;
            font-size: 0.9rem;
        }
        nav a:hover { background: var(--color-secundario); }
        .container {
            padding: 20px;
            max-width: 1100px;
            margin: 0 auto;
        }
        h2 {
            color: var(--color-primario);
            margin-top: 0;
        }
        .card {
            background: var(--color-blanco);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
        .card ul { padding-left: 20px; }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.72rem;
            background: var(--color-secundario);
            color: var(--color-blanco);
            margin-right: 6px;
        }
        .info {
            font-size: 0.85rem;
            color: #555;
        }
        .tabla {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .tabla th,
        .tabla td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }
        .tabla th {
            background: #bbdefb;
        }
        details summary {
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 5px;
        }
        details { margin-top: 10px; }
        .alerta {
            background: #fff3cd;
            border-left: 4px solid #ffca2c;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-top: 10px;
        }
        .portada {
            margin: 15px 0 10px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .portada img { width: 100%; display: block; }
        .portada-texto {
            text-align: center;
            font-size: 0.9rem;
            margin-top: 5px;
            color: #444;
        }
        .galeria {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .galeria img {
            width: 100%;
            border-radius: 8px;
            border: 2px solid var(--color-blanco);
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }
        .filtros {
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            font-size: 0.85rem;
        }
        .filtros label { font-weight: bold; }
        .filtros select {
            padding: 4px 6px;
            font-size: 0.85rem;
        }
        .rol-indicador {
            font-size: 0.8rem;
            color: #eee;
            margin-top: 4px;
        }
        .resumen-estudiante {
            font-size: 0.85rem;
            background: #e3f2fd;
            border-left: 4px solid var(--color-secundario);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .btn-tareas {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid var(--color-primario);
            background: var(--color-blanco);
            color: var(--color-primario);
            cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-tareas:hover {
            background: var(--color-secundario);
            color: var(--color-blanco);
        }
        .panel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }
        .panel-card {
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 10px;
            background: #f5f9ff;
            font-size: 0.85rem;
        }
        .panel-card h3 {
            margin-top: 0;
            font-size: 0.95rem;
            color: var(--color-primario);
        }
        .panel-card label {
            display: block;
            margin-top: 6px;
            margin-bottom: 2px;
            font-weight: bold;
        }
        .panel-card select,
        .panel-card input,
        .panel-card textarea {
            width: 100%;
            padding: 4px 6px;
            font-size: 0.8rem;
            border-radius: 4px;
            border: 1px solid #bbb;
        }
        .panel-card button {
            margin-top: 8px;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            background: var(--color-primario);
            color: var(--color-blanco);
            font-size: 0.8rem;
            cursor: pointer;
        }
        .panel-card button:hover {
            background: var(--color-secundario);
        }
        .panel-ayuda {
            font-size: 0.8rem;
            color: #555;
            margin-top: 5px;
        }
        footer {
            background: var(--color-primario);
            color: var(--color-blanco);
            text-align: center;
            padding: 15px;
            margin-top: 40px;
            font-size: 0.8rem;
        }
        @media (max-width: 600px) {
            header h1 { font-size: 1.4rem; }
            nav a {
                font-size: 0.8rem;
                padding: 8px 10px;
            }
            .filtros {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body>

<!-- PANTALLA DE ACCESO -->
<section id="pantalla-acceso">
    <div class="acceso-card">
        <h1>San Pio X Plataforma Escolar</h1>
        <p>Acceso a la información del 2º Año, paralelos A y B.</p>

        <div class="acceso-group">
            <label>Tipo de usuario</label>
            <div class="acceso-opciones">
                <label><input type="radio" name="rol" value="docente" checked> Docente / Administrador</label>
                <label><input type="radio" name="rol" value="familia"> Madre, padre o tutor</label>
            </div>
        </div>

        <div class="acceso-group">
            <label for="codigoAcceso">Código de acceso</label>
            <input type="password" id="codigoAcceso" class="acceso-input" placeholder="Ingrese el código">
            <div class="acceso-ver-clave">
                <label><input type="checkbox" id="toggleVerClave"> Mostrar caracteres</label>
            </div>
        </div>

        <button class="acceso-boton" id="btnIngresar">Ingresar</button>
        <div class="acceso-error" id="mensajeError"></div>
    </div>
</section>

<!-- APLICACIÓN PRINCIPAL -->
<div id="app" style="display:none;">
    <header>
        <h1>San Pio X Plataforma Escolar</h1>
        <p>2º Año - Paralelos A y B · Administrado por <b>William &amp; Franklin</b></p>
        <div class="rol-indicador" id="textoRol"></div>
    </header>

    <nav>
        <a href="#bienvenida">Inicio</a>
        <a href="#guia">Guía para Padres</a>
        <a href="#a-notas" id="linkNotas2A">Notas 2ºA</a>
        <a href="#b-notas" id="linkNotas2B">Notas 2ºB</a>
        <a href="#a-tareas" id="linkTareas2A">Tareas 2ºA</a>
        <a href="#b-tareas" id="linkTareas2B">Tareas 2ºB</a>
        <a href="#asistencia">Asistencia</a>
        <a href="#comunicados">Comunicados</a>
        <a href="#material">Material de apoyo</a>
        <a href="#faq">Preguntas frecuentes</a>
        <a href="#panel-docente" id="linkPanelDocente" style="display:none;">Panel docente</a>
    </nav>

    <div class="container">

        <div id="resumenEstudiante" class="resumen-estudiante" style="display:none;"></div>

        <!-- PORTADA -->
        <section class="card" id="portada">
            <h2>Portada</h2>
            <div class="portada">
                <img src="imagenes/portada-ejemplo.jpg" alt="Unidad Educativa San Pio X">
            </div>
            <p class="portada-texto">
                San Pio X · 2º Año A y B
            </p>
        </section>

        <!-- BIENVENIDA -->
        <section id="bienvenida" class="card">
            <h2>Bienvenida</h2>
            <p>Estimadas madres y padres de familia:</p>
            <p>
                Bienvenidos a la <b>San Pio X Plataforma Escolar</b>, un espacio para acompañar el proceso de aprendizaje
                de sus hijas e hijos de <b>2º Año, paralelos A y B</b>.
            </p>
            <p>Desde aquí podrán revisar:</p>
            <ul>
                <li>Notas por área y trimestre (Ser, Saber, Hacer, Decidir, Autoevaluación y promedio final).</li>
                <li>Tareas asignadas y si fueron realizadas o no.</li>
                <li>Asistencia diaria de lunes a viernes.</li>
                <li>Comunicados y avisos importantes.</li>
                <li>Material de apoyo para el estudio en casa.</li>
            </ul>
        </section>

        <!-- GUÍA PARA PADRES -->
        <section id="guia" class="card">
            <h2>Guía para Padres de Familia</h2>
            <ol>
                <li>
                    <b>Navegación básica</b><br>
                    Use el menú superior para ir a Notas, Tareas, Asistencia, Comunicados y Material de apoyo.
                </li>
                <li>
                    <b>Paralelo</b><br>
                    La plataforma diferencia entre <span class="badge">2ºA</span> y <span class="badge">2ºB</span>.
                </li>
                <li>
                    <b>Calificaciones</b><br>
                    Las notas se organizan por trimestre y por áreas, considerando:
                    Ser (5 pts), Saber (45), Hacer (40), Decidir (5) y Autoevaluación (5).
                    La suma de estas cinco notas forma el <b>promedio final</b> (sobre 100 pts).
                    La nota mínima de aprobación es <b>51 puntos</b>.
                </li>
                <li>
                    <b>Uso responsable</b><br>
                    La información es de uso interno de la comunidad educativa.
                </li>
            </ol>

            <div class="alerta">
                Para familias, el código de acceso se basa en el primer apellido y nombre del estudiante.
            </div>
        </section>

        <!-- NOTAS 2ºA -->
        <section id="a-notas" class="card">
            <h2>Notas - 2ºA</h2>
            <p class="info" id="textoNotas2A">
                Filtros de estudiante, trimestre y área. Las calificaciones se muestran por competencias:
                Ser (5), Saber (45), Hacer (40), Decidir (5) y Autoevaluación (5).  
                La nota mínima de aprobación es 51 puntos sobre 100.
            </p>

            <div class="filtros" id="filtros2A">
                <label for="filtroAlumno2A">Estudiante:</label>
                <select id="filtroAlumno2A"></select>

                <label for="filtroTrimestre2A">Trimestre:</label>
                <select id="filtroTrimestre2A">
                    <option value="">Todos</option>
                    <option value="1º">1º</option>
                    <option value="2º">2º</option>
                </select>

                <label for="filtroArea2A">Área:</label>
                <select id="filtroArea2A">
                    <option value="">Todas</option>
                    <option value="Matemática">Matemática</option>
                    <option value="Lenguaje">Lenguaje</option>
                    <option value="Ciencias Sociales">Ciencias Sociales</option>
                    <option value="Ciencias Naturales">Ciencias Naturales</option>
                    <option value="Artes Plásticas">Artes Plásticas</option>
                </select>
            </div>

            <table class="tabla" id="tablaNotas2A">
                <thead>
                    <tr>
                        <th>Estudiante</th>
                        <th>Área</th>
                        <th>Trimestre</th>
                        <th>Ser (5)</th>
                        <th>Saber (45)</th>
                        <th>Hacer (40)</th>
                        <th>Decidir (5)</th>
                        <th>Autoeval. (5)</th>
                        <th>Promedio final (100)</th>
                        <th>Observación</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- NOTAS 2ºB -->
        <section id="b-notas" class="card">
            <h2>Notas - 2ºB</h2>
            <p class="info" id="textoNotas2B">
                Filtros de estudiante, trimestre y área. Las calificaciones se muestran por competencias:
                Ser (5), Saber (45), Hacer (40), Decidir (5) y Autoevaluación (5).  
                La nota mínima de aprobación es 51 puntos sobre 100.
            </p>

            <div class="filtros" id="filtros2B">
                <label for="filtroAlumno2B">Estudiante:</label>
                <select id="filtroAlumno2B"></select>

                <label for="filtroTrimestre2B">Trimestre:</label>
                <select id="filtroTrimestre2B">
                    <option value="">Todos</option>
                    <option value="1º">1º</option>
                    <option value="2º">2º</option>
                </select>

                <label for="filtroArea2B">Área:</label>
                <select id="filtroArea2B">
                    <option value="">Todas</option>
                    <option value="Matemática">Matemática</option>
                    <option value="Lenguaje">Lenguaje</option>
                    <option value="Ciencias Sociales">Ciencias Sociales</option>
                    <option value="Ciencias Naturales">Ciencias Naturales</option>
                    <option value="Artes Plásticas">Artes Plásticas</option>
                </select>
            </div>

            <table class="tabla" id="tablaNotas2B">
                <thead>
                    <tr>
                        <th>Estudiante</th>
                        <th>Área</th>
                        <th>Trimestre</th>
                        <th>Ser (5)</th>
                        <th>Saber (45)</th>
                        <th>Hacer (40)</th>
                        <th>Decidir (5)</th>
                        <th>Autoeval. (5)</th>
                        <th>Promedio final (100)</th>
                        <th>Observación</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- TAREAS 2ºA -->
        <section id="a-tareas" class="card">
            <h2>Tareas - 2ºA</h2>
            <p class="info">
                Tareas del paralelo 2ºA.  
                Docentes: marcan si cada estudiante realizó o no la tarea.  
                Familias: solo visualizan el estado de las tareas de su hija o hijo.
            </p>

            <div class="filtros">
                <button type="button" class="btn-tareas" data-target="tablaTareas2A" data-modo="recientes">
                    Tareas recientes (7 días)
                </button>
                <button type="button" class="btn-tareas" data-target="tablaTareas2A" data-modo="todas">
                    Todas las tareas
                </button>
            </div>

            <table class="tabla" id="tablaTareas2A">
                <thead>
                    <tr>
                        <th>Tarea</th>
                        <th>Fecha asignación</th>
                        <th>Fecha entrega</th>
                        <th>Área</th>
                        <th>Estudiante</th>
                        <th>Realizada</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- TAREAS 2ºB -->
        <section id="b-tareas" class="card">
            <h2>Tareas - 2ºB</h2>
            <p class="info">
                Tareas del paralelo 2ºB.  
                Docentes: marcan si cada estudiante realizó o no la tarea.  
                Familias: solo visualizan el estado de las tareas de su hija o hijo.
            </p>

            <div class="filtros">
                <button type="button" class="btn-tareas" data-target="tablaTareas2B" data-modo="recientes">
                    Tareas recientes (7 días)
                </button>
                <button type="button" class="btn-tareas" data-target="tablaTareas2B" data-modo="todas">
                    Todas las tareas
                </button>
            </div>

            <table class="tabla" id="tablaTareas2B">
                <thead>
                    <tr>
                        <th>Tarea</th>
                        <th>Fecha asignación</th>
                        <th>Fecha entrega</th>
                        <th>Área</th>
                        <th>Estudiante</th>
                        <th>Realizada</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- ASISTENCIA -->
        <section id="asistencia" class="card">
            <h2>Asistencia - 2ºA y 2ºB</h2>
            <p class="info" id="textoAsistencia">
                Registro centralizado de asistencia de Lunes a Viernes para toda la nómina de estudiantes.  
                Docentes: seleccionan día y paralelo para controlar la asistencia (Presente, Atraso o Falta).  
                Familias: solo se muestra la asistencia del estudiante.
            </p>

            <div class="filtros" id="filtrosAsistencia">
                <label for="selectDiaAsistencia">Día:</label>
                <select id="selectDiaAsistencia"></select>

                <label for="selectParaleloAsistencia">Paralelo:</label>
                <select id="selectParaleloAsistencia">
                    <option value="">Todos</option>
                    <option value="2ºA">2ºA</option>
                    <option value="2ºB">2ºB</option>
                </select>
            </div>

            <table class="tabla" id="tablaAsistencia">
                <thead>
                    <tr>
                        <th>Día</th>
                        <th>Estudiante</th>
                        <th>Paralelo</th>
                        <th>Estado</th>
                        <th>Observación</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- PANEL DOCENTE (EDICIÓN EN LA PÁGINA) -->
        <section id="panel-docente" class="card" style="display:none;">
            <h2>Panel docente (edición rápida)</h2>
            <p class="info">
                Los cambios que realice aquí se aplican en la página mientras esté abierta.
                Al recargar, se pierden (porque la plataforma es estática).  
                Para hacerlos permanentes, descargue el archivo JSON y luego actualice los datos en el código.
            </p>

            <div class="panel-grid">
                <!-- Bloque para edición de notas -->
                <div class="panel-card">
                    <h3>Registrar / actualizar nota</h3>
                    <label for="panelParalelo">Paralelo</label>
                    <select id="panelParalelo">
                        <option value="2ºA">2ºA</option>
                        <option value="2ºB">2ºB</option>
                    </select>

                    <label for="panelAlumno">Estudiante</label>
                    <select id="panelAlumno"></select>

                    <label for="panelTrimestre">Trimestre</label>
                    <select id="panelTrimestre">
                        <option value="1º">1º</option>
                        <option value="2º">2º</option>
                    </select>

                    <label for="panelArea">Área</label>
                    <select id="panelArea">
                        <option value="Matemática">Matemática</option>
                        <option value="Lenguaje">Lenguaje</option>
                        <option value="Ciencias Sociales">Ciencias Sociales</option>
                        <option value="Ciencias Naturales">Ciencias Naturales</option>
                        <option value="Artes Plásticas">Artes Plásticas</option>
                    </select>

                    <label>Ser (0–5)</label>
                    <input type="number" id="panelSer" min="0" max="5" step="1" placeholder="0 a 5">

                    <label>Saber (0–45)</label>
                    <input type="number" id="panelSaber" min="0" max="45" step="1" placeholder="0 a 45">

                    <label>Hacer (0–40)</label>
                    <input type="number" id="panelHacer" min="0" max="40" step="1" placeholder="0 a 40">

                    <label>Decidir (0–5)</label>
                    <input type="number" id="panelDecidir" min="0" max="5" step="1" placeholder="0 a 5">

                    <label>Autoevaluación (0–5)</label>
                    <input type="number" id="panelAutoeval" min="0" max="5" step="1" placeholder="0 a 5">

                    <button type="button" id="btnGuardarNota">Guardar nota</button>
                    <div class="panel-ayuda">
                        El promedio final se calcula automáticamente como suma de las cinco notas (máximo 100).
                        La observación se genera con un mensaje positivo de refuerzo, según el promedio final.
                    </div>
                </div>

                <!-- Bloque exportación/guardado -->
                <div class="panel-card">
                    <h3>Respaldo de datos</h3>
                    <p class="panel-ayuda">
                        Use estos botones para respaldar y recuperar todas las notas, asistencias y estados de tareas.
                    </p>
                    <button type="button" id="btnDescargarJSON">Descargar datos (JSON)</button>
                    <button type="button" id="btnDescargarCSV">Descargar datos (CSV)</button>
                    <button type="button" id="btnGuardarLocal">Guardar datos en esta computadora</button>
                    <button type="button" id="btnCargarLocal">Cargar datos guardados</button>
                    <p class="panel-ayuda">
                        El guardado en computadora funciona por navegador.  
                        Si usa otra PC o borra los datos del navegador, el respaldo recomendado es el archivo JSON/CSV.
                    </p>
                </div>
            </div>
        </section>

        <!-- COMUNICADOS -->
        <section id="comunicados" class="card">
            <h2>Comunicados</h2>
            <ul>
                <li>Reunión de padres de familia del paralelo 2ºA – 30/11/2025 a horas 18:00.</li>
                <li>Entrega de libretas del 1º trimestre – Fecha por confirmar.</li>
            </ul>

            <div class="galeria">
                <!-- Imágenes de comunicados cuando se agreguen -->
            </div>
        </section>

        <!-- MATERIAL DE APOYO -->
        <section id="material" class="card">
            <h2>Material de apoyo</h2>
            <ul>
                <li>Guías de lectura y escritura.</li>
                <li>Fichas de operaciones básicas de matemática.</li>
                <li>Enlaces a videos educativos seleccionados por los docentes.</li>
            </ul>
        </section>

        <!-- PREGUNTAS FRECUENTES -->
        <section id="faq" class="card">
            <h2>Preguntas frecuentes (FAQ)</h2>

            <details>
                <summary>¿Debo crear una cuenta para acceder?</summary>
                <p>No. Solo necesita el código de acceso.</p>
            </details>

            <details>
                <summary>¿Cada cuánto se actualizan las notas?</summary>
                <p>Las notas se actualizan por trimestre.</p>
            </details>

            <details>
                <summary>¿Qué hago si veo un error en los datos?</summary>
                <p>Debe comunicarse con los docentes por los canales oficiales.</p>
            </details>

            <details>
                <summary>¿Puedo compartir esta página?</summary>
                <p>Se recomienda compartir el enlace solo con madres, padres o tutores autorizados.</p>
            </details>
        </section>

    </div>

    <footer>
        San Pio X Plataforma Escolar · 2º Año A y B · Desarrollado por William &amp; Franklin
    </footer>
</div>

<!-- JAVASCRIPT -->
<script>
// Código docente (general)
const CODIGO_DOCENTE = "DOCENTE2025";

let rolActual = null;
let alumnoActual = null;
let paraleloActual = null;

// Normalizar clave de familia
function normalizarCodigoFamilia(str) {
    return str
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, " ")
        .trim();
}

// Mapa de códigos individuales de familia
const codigosFamilia = {};
function registrarCodigo(clave, alumno, paralelo) {
    codigosFamilia[normalizarCodigoFamilia(clave)] = { alumno, paralelo };
}

// Registrar códigos por estudiante (primer apellido + nombre)
registrarCodigo("Balderrama Marcos", "Balderrama Choque Marcos Dyland", "2ºA");
registrarCodigo("Calle Zoe", "Calle  Pariguana Zoe Sofia", "2ºA");
registrarCodigo("Cardenas Dimar", "Cardenas Chacon Dimar Santos", "2ºA");
registrarCodigo("Ibanez Erik", "Ibañez Garnica Erik  Jhair", "2ºA");
registrarCodigo("Lopez Jonathan", "Lopez Vega  Jonathan Joseph", "2ºA");
registrarCodigo("Lovera Nataly", "Lovera Revollo Nataly", "2ºA");
registrarCodigo("Male Nazaline", "Male Rodas  Nazaline", "2ºA");
registrarCodigo("Mamani Cristan", "Mamani  Mendez Cristan", "2ºA");
registrarCodigo("Nunez Luis", "Nuñez Lopez Luis Yair", "2ºA");
registrarCodigo("Ontiveros Erick", "Ontiveros Rivera Erick Matias", "2ºA");
registrarCodigo("Ortega Marian", "Ortega Rivera Marian Valentina", "2ºA");
registrarCodigo("Ortiz Jhinaguissel", "Ortiz Encinas JhinaGuissel", "2ºA");
registrarCodigo("Poma Daira", "Poma  Vargas  Daira  Jasmin", "2ºA");
registrarCodigo("Ramos Sofia", "Ramos Miranda  Sofia", "2ºA");
registrarCodigo("Requelme Brillit", "Requelme Arancibia BRILLIT", "2ºA");
registrarCodigo("Rodas Ayned", "Rodas  Carballo Ayned  Masiel", "2ºA");
registrarCodigo("Ruiz Aysel", "Ruiz Rodas  Aysel", "2ºA");
registrarCodigo("Solis Marilet", "Solis  Salazar  Marilet", "2ºA");
registrarCodigo("Yamandiry Liam", "Yamandiry Diaz  Liam  Abdiel", "2ºA");

registrarCodigo("Aguilar Valentina", "AGUILAR VALENTINA MARGARITA", "2ºB");
registrarCodigo("Avila Erick", "AVILA PLATA ERICK JHOEL", "2ºB");
registrarCodigo("Ayllon Marines", "AYLLON HINOJOSA MARINES", "2ºB");
registrarCodigo("Ballejos Alison", "BALLEJOS REVOLLO ALISON DANAE", "2ºB");
registrarCodigo("Barja Zeineth", "BARJA LOPEZ ZEINETH", "2ºB");
registrarCodigo("Beltran Stiven", "BELTRAN LOPEZ  STIVEN FRANCO", "2ºB");
registrarCodigo("Carballo Ismael", "CARBALLO BERAMENDI ISMAEL", "2ºB");
registrarCodigo("Chavarria Paul", "CHAVARRIA BARJA PAUL THIAGO", "2ºB");
registrarCodigo("Copa Carlos", "COPA DIAZ CARLOS DANIEL", "2ºB");
registrarCodigo("Fernandez Vayolet", "FERNANDEZ VELASCO VAYOLET YARELY", "2ºB");
registrarCodigo("Flores Albaro", "FLORES QUIROGA ALBARO AARON", "2ºB");
registrarCodigo("Flores Rene", "FLORES OVANDO RENE ALI ", "2ºB");
registrarCodigo("Gonzales Emily", "GONZALES PANIAGUA EMILY CRISTAL", "2ºB");
registrarCodigo("Lopez Hesel", "LOPEZ RODAS HESEL AINOHA", "2ºB");
registrarCodigo("Miranda Eithan", "MIRANDA RUIZ EITHAN", "2ºB");
registrarCodigo("Ortega Jhon", "ORTEGA MOLINA JHON MAICOL", "2ºB");
registrarCodigo("Ortiz Fernanda", "ORTIZ CEREZO FERNANDA", "2ºB");
registrarCodigo("Pardo Dannely", "PARDO PADILLA DANNELY SARAI", "2ºB");
registrarCodigo("Quispe Jhosep", "QUISPE SANDOVAL JHOSEP", "2ºB");
registrarCodigo("Ruiz Erick", "RUIZ ALARCON ERICK MIJAEL", "2ºB");
registrarCodigo("Sardan Aysel", "SARDAN ZAMBRANA AYSEL DESIREE", "2ºB");
registrarCodigo("Vega Angel", "VEGA SALAZAR ANGEL GAEL ", "2ºB");
registrarCodigo("Zelaya Victoria", "ZELAYA SALAZAR VICTORIA MASSIEL", "2ºB");

// Listas de alumnos
const alumnos2A = [
    "Balderrama Choque Marcos Dyland",
    "Calle  Pariguana Zoe Sofia",
    "Cardenas Chacon Dimar Santos",
    "Ibañez Garnica Erik  Jhair",
    "Lopez Vega  Jonathan Joseph",
    "Lovera Revollo Nataly",
    "Male Rodas  Nazaline",
    "Mamani  Mendez Cristan",
    "Nuñez Lopez Luis Yair",
    "Ontiveros Rivera Erick Matias",
    "Ortega Rivera Marian Valentina",
    "Ortiz Encinas JhinaGuissel",
    "Poma  Vargas  Daira  Jasmin",
    "Ramos Miranda  Sofia",
    "Requelme Arancibia BRILLIT",
    "Rodas  Carballo Ayned  Masiel",
    "Ruiz Rodas  Aysel",
    "Solis  Salazar  Marilet",
    "Yamandiry Diaz  Liam  Abdiel"
];

const alumnos2B = [
    "AGUILAR VALENTINA MARGARITA",
    "AVILA PLATA ERICK JHOEL",
    "AYLLON HINOJOSA MARINES",
    "BALLEJOS REVOLLO ALISON DANAE",
    "BARJA LOPEZ ZEINETH",
    "BELTRAN LOPEZ  STIVEN FRANCO",
    "CARBALLO BERAMENDI ISMAEL",
    "CHAVARRIA BARJA PAUL THIAGO",
    "COPA DIAZ CARLOS DANIEL",
    "FERNANDEZ VELASCO VAYOLET YARELY",
    "FLORES QUIROGA ALBARO AARON",
    "FLORES OVANDO RENE ALI ",
    "GONZALES PANIAGUA EMILY CRISTAL",
    "LOPEZ RODAS HESEL AINOHA",
    "MIRANDA RUIZ EITHAN",
    "ORTEGA MOLINA JHON MAICOL",
    "ORTIZ CEREZO FERNANDA",
    "PARDO PADILLA DANNELY SARAI",
    "QUISPE SANDOVAL JHOSEP",
    "RUIZ ALARCON ERICK MIJAEL",
    "SARDAN ZAMBRANA AYSEL DESIREE",
    "VEGA SALAZAR ANGEL GAEL ",
    "ZELAYA SALAZAR VICTORIA MASSIEL"
];

const areasCalificacion = [
    "Matemática",
    "Lenguaje",
    "Ciencias Sociales",
    "Ciencias Naturales",
    "Artes Plásticas"
];

const trimestresCalificacion = ["1º", "2º"];

// TAREAS: definición de tareas por paralelo
const tareas2A = [
    {
        id: 1,
        titulo: "Suma y resta",
        fechaAsignacion: "20/11/2025",
        fechaEntrega: "22/11/2025",
        area: "Matemática",
        descripcion: "Resolver 5 ejercicios de suma y resta."
    },
    {
        id: 2,
        titulo: "Mi familia",
        fechaAsignacion: "10/11/2025",
        fechaEntrega: "13/11/2025",
        area: "Lenguaje",
        descripcion: "Redactar una pequeña descripción de su familia."
    }
];

const tareas2B = [
    {
        id: 1,
        titulo: "Partes de la planta",
        fechaAsignacion: "21/11/2025",
        fechaEntrega: "24/11/2025",
        area: "Ciencias Naturales",
        descripcion: "Dibujar una planta y señalar sus partes."
    },
    {
        id: 2,
        titulo: "Costumbre de la comunidad",
        fechaAsignacion: "11/11/2025",
        fechaEntrega: "14/11/2025",
        area: "Ciencias Sociales",
        descripcion: "Investigar una costumbre de su comunidad."
    }
];

// Estado de tareas por estudiante
let estadoTareas2A = [];
let estadoTareas2B = [];

// Arreglos de notas
const datosNotas2A = [];
const datosNotas2B = [];

// Nota mínima de aprobación
const NOTA_APROBACION = 51;

// Generar observación positiva según nota
function generarObservacion(nota, area) {
    if (nota >= NOTA_APROBACION) {
        return `Buen desempeño en ${area}. El estudiante está aprobado; se recomienda continuar con el mismo esfuerzo y seguir fortaleciendo sus habilidades.`;
    } else {
        return `En ${area} se observan aspectos por mejorar. Se sugiere seguir practicando con calma, pedir ayuda cuando lo necesite y valorar cada avance que va logrando.`;
    }
}

// Aleatorio entero entre min y max (incluidos)
function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

// Generar datos ficticios de notas para todos los estudiantes (1º y 2º trimestre, todas las áreas)
function generarNotasIniciales() {
    alumnos2A.forEach(alumno => {
        trimestresCalificacion.forEach(trim => {
            areasCalificacion.forEach(area => {
                const ser = randInt(1, 5);
                const saber = randInt(1, 45);
                const hacer = randInt(1, 40);
                const decidir = randInt(1, 5);
                const autoeval = randInt(1, 5);
                const notaFinal = ser + saber + hacer + decidir + autoeval;
                const obs = generarObservacion(notaFinal, area);

                datosNotas2A.push({
                    alumno,
                    area,
                    trimestre: trim,
                    ser,
                    saber,
                    hacer,
                    decidir,
                    autoeval,
                    nota: notaFinal,
                    obs
                });
            });
        });
    });

    alumnos2B.forEach(alumno => {
        trimestresCalificacion.forEach(trim => {
            areasCalificacion.forEach(area => {
                const ser = randInt(1, 5);
                const saber = randInt(1, 45);
                const hacer = randInt(1, 40);
                const decidir = randInt(1, 5);
                const autoeval = randInt(1, 5);
                const notaFinal = ser + saber + hacer + decidir + autoeval;
                const obs = generarObservacion(notaFinal, area);

                datosNotas2B.push({
                    alumno,
                    area,
                    trimestre: trim,
                    ser,
                    saber,
                    hacer,
                    decidir,
                    autoeval,
                    nota: notaFinal,
                    obs
                });
            });
        });
    });
}

// Generar datos ficticios de tareas: estado por estudiante (por defecto: no realizada)
function generarEstadoInicialTareas() {
    estadoTareas2A = [];
    estadoTareas2B = [];

    alumnos2A.forEach(alumno => {
        tareas2A.forEach(t => {
            estadoTareas2A.push({
                tareaId: t.id,
                alumno,
                realizada: false
            });
        });
    });

    alumnos2B.forEach(alumno => {
        tareas2B.forEach(t => {
            estadoTareas2B.push({
                tareaId: t.id,
                alumno,
                realizada: false
            });
        });
    });
}

// Asistencia: días de lunes a viernes
const diasSemana = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];
let datosAsistencia = [];

// Inicializar asistencia para todos los estudiantes y todos los días
function inicializarAsistenciaSemana() {
    datosAsistencia = [];
    let id = 1;

    alumnos2A.forEach(alumno => {
        diasSemana.forEach(dia => {
            datosAsistencia.push({
                id: id++,
                dia,
                alumno,
                paralelo: "2ºA",
                estado: "Presente",
                obs: ""
            });
        });
    });

    alumnos2B.forEach(alumno => {
        diasSemana.forEach(dia => {
            datosAsistencia.push({
                id: id++,
                dia,
                alumno,
                paralelo: "2ºB",
                estado: "Presente",
                obs: ""
            });
        });
    });
}

// Generar datos iniciales
generarNotasIniciales();
generarEstadoInicialTareas();

// Utilidades
function obtenerListaAlumnos(datos) {
    const nombres = datos.map(d => d.alumno);
    return Array.from(new Set(nombres)).sort();
}

function llenarSelectAlumnos(selectId, datos) {
    const select = document.getElementById(selectId);
    select.innerHTML = "";
    const opcionTodos = document.createElement("option");
    opcionTodos.value = "";
    opcionTodos.textContent = "Todos los estudiantes";
    select.appendChild(opcionTodos);

    obtenerListaAlumnos(datos).forEach(nombre => {
        const opt = document.createElement("option");
        opt.value = nombre;
        opt.textContent = nombre;
        select.appendChild(opt);
    });
}

function renderTablaNotas(tablaId, datos, filtros = {}) {
    const tbody = document.querySelector(`#${tablaId} tbody`);
    tbody.innerHTML = "";

    let datosFiltrados = datos;

    if (filtros.alumno) {
        datosFiltrados = datosFiltrados.filter(d => d.alumno === filtros.alumno);
    }
    if (filtros.trimestre) {
        datosFiltrados = datosFiltrados.filter(d => d.trimestre === filtros.trimestre);
    }
    if (filtros.area) {
        datosFiltrados = datosFiltrados.filter(d => d.area === filtros.area);
    }

    if (datosFiltrados.length === 0) {
        const fila = document.createElement("tr");
        const celda = document.createElement("td");
        celda.colSpan = 10;
        celda.textContent = "No hay registros para mostrar.";
        fila.appendChild(celda);
        tbody.appendChild(fila);
        return;
    }

    datosFiltrados.forEach(d => {
        const fila = document.createElement("tr");

        const cAlumno = document.createElement("td");
        cAlumno.textContent = d.alumno;
        fila.appendChild(cAlumno);

        const cArea = document.createElement("td");
        cArea.textContent = d.area;
        fila.appendChild(cArea);

        const cTrim = document.createElement("td");
        cTrim.textContent = d.trimestre;
        fila.appendChild(cTrim);

        const cSer = document.createElement("td");
        cSer.textContent = d.ser;
        fila.appendChild(cSer);

        const cSaber = document.createElement("td");
        cSaber.textContent = d.saber;
        fila.appendChild(cSaber);

        const cHacer = document.createElement("td");
        cHacer.textContent = d.hacer;
        fila.appendChild(cHacer);

        const cDecidir = document.createElement("td");
        cDecidir.textContent = d.decidir;
        fila.appendChild(cDecidir);

        const cAuto = document.createElement("td");
        cAuto.textContent = d.autoeval;
        fila.appendChild(cAuto);

        const cNota = document.createElement("td");
        cNota.textContent = d.nota;
        fila.appendChild(cNota);

        const cObs = document.createElement("td");
        cObs.textContent = d.obs || "";
        fila.appendChild(cObs);

        tbody.appendChild(fila);
    });
}

// Render asistencia con filtros: nombre, día, paralelo
function renderTablaAsistencia(filtros = {}) {
    const tbody = document.querySelector("#tablaAsistencia tbody");
    tbody.innerHTML = "";

    let datosFiltrados = datosAsistencia;

    if (filtros.nombre) {
        datosFiltrados = datosFiltrados.filter(d => d.alumno === filtros.nombre);
    }
    if (filtros.dia) {
        datosFiltrados = datosFiltrados.filter(d => d.dia === filtros.dia);
    }
    if (filtros.paralelo) {
        datosFiltrados = datosFiltrados.filter(d => d.paralelo === filtros.paralelo);
    }

    if (datosFiltrados.length === 0) {
        const fila = document.createElement("tr");
        const celda = document.createElement("td");
        celda.colSpan = 5;
        celda.textContent = "No hay registros para mostrar.";
        fila.appendChild(celda);
        tbody.appendChild(fila);
        return;
    }

    datosFiltrados.forEach(d => {
        const fila = document.createElement("tr");

        const cDia = document.createElement("td");
        cDia.textContent = d.dia;
        fila.appendChild(cDia);

        const cAlumno = document.createElement("td");
        cAlumno.textContent = d.alumno;
        fila.appendChild(cAlumno);

        const cParalelo = document.createElement("td");
        cParalelo.textContent = d.paralelo;
        fila.appendChild(cParalelo);

        const cEstado = document.createElement("td");
        if (rolActual === "docente") {
            const sel = document.createElement("select");
            ["Presente", "Atraso", "Falta"].forEach(op => {
                const o = document.createElement("option");
                o.value = op;
                o.textContent = op;
                sel.appendChild(o);
            });
            sel.value = d.estado;
            sel.dataset.id = d.id;
            sel.addEventListener("change", (e) => {
                const id = parseInt(e.target.dataset.id, 10);
                const idx = datosAsistencia.findIndex(reg => reg.id === id);
                if (idx !== -1) {
                    datosAsistencia[idx].estado = e.target.value;
                }
            });
            cEstado.appendChild(sel);
        } else {
            cEstado.textContent = d.estado;
        }
        fila.appendChild(cEstado);

        const cObs = document.createElement("td");
        cObs.textContent = d.obs || "";
        fila.appendChild(cObs);

        tbody.appendChild(fila);
    });
}

// Parsear fecha dd/mm/yyyy a objeto Date
function parseFecha(fechaTexto) {
    const partes = fechaTexto.split("/");
    if (partes.length !== 3) return null;
    const dia = parseInt(partes[0], 10);
    const mes = parseInt(partes[1], 10) - 1;
    const anio = parseInt(partes[2], 10);
    return new Date(anio, mes, dia);
}

// Renderizar tabla de tareas por paralelo y modo (recientes/todas)
function renderTablaTareas(paralelo, modo = "todas") {
    const esA = paralelo === "2ºA";
    const tareas = esA ? tareas2A : tareas2B;
    const estados = esA ? estadoTareas2A : estadoTareas2B;
    const alumnos = esA ? alumnos2A : alumnos2B;
    const tablaId = esA ? "tablaTareas2A" : "tablaTareas2B";

    const tbody = document.querySelector(`#${tablaId} tbody`);
    tbody.innerHTML = "";

    const hoy = new Date();
    let hayRegistros = false;

    tareas.forEach(tarea => {
        const fechaAsig = parseFecha(tarea.fechaAsignacion);
        if (modo === "recientes" && fechaAsig) {
            const diffMs = hoy - fechaAsig;
            const dias = diffMs / (1000 * 60 * 60 * 24);
            if (dias > 7) {
                return; // no mostrar
            }
        }

        alumnos.forEach(alumno => {
            // Si es familia, solo se muestra el hijo/hija correspondiente
            if (rolActual === "familia" && alumno !== alumnoActual) return;

            const reg = estados.find(r => r.tareaId === tarea.id && r.alumno === alumno);
            const realizada = reg ? reg.realizada : false;

            const fila = document.createElement("tr");

            const cTarea = document.createElement("td");
            cTarea.textContent = tarea.titulo;
            fila.appendChild(cTarea);

            const cFA = document.createElement("td");
            cFA.textContent = tarea.fechaAsignacion;
            fila.appendChild(cFA);

            const cFE = document.createElement("td");
            cFE.textContent = tarea.fechaEntrega;
            fila.appendChild(cFE);

            const cArea = document.createElement("td");
            cArea.textContent = tarea.area;
            fila.appendChild(cArea);

            const cAlumno = document.createElement("td");
            cAlumno.textContent = alumno;
            fila.appendChild(cAlumno);

            const cRealizada = document.createElement("td");
            if (rolActual === "docente") {
                const chk = document.createElement("input");
                chk.type = "checkbox";
                chk.checked = realizada;
                chk.dataset.paralelo = paralelo;
                chk.dataset.tareaId = tarea.id;
                chk.dataset.alumno = alumno;
                chk.addEventListener("change", (e) => {
                    const p = e.target.dataset.paralelo;
                    const idT = parseInt(e.target.dataset.tareaId, 10);
                    const alu = e.target.dataset.alumno;
                    const arr = p === "2ºA" ? estadoTareas2A : estadoTareas2B;
                    const regEncontrado = arr.find(r => r.tareaId === idT && r.alumno === alu);
                    if (regEncontrado) {
                        regEncontrado.realizada = e.target.checked;
                    }
                });
                cRealizada.appendChild(chk);
            } else {
                cRealizada.textContent = realizada ? "Sí" : "No";
            }
            fila.appendChild(cRealizada);

            tbody.appendChild(fila);
            hayRegistros = true;
        });
    });

    if (!hayRegistros) {
        const fila = document.createElement("tr");
        const celda = document.createElement("td");
        celda.colSpan = 6;
        celda.textContent = "No hay registros para mostrar.";
        fila.appendChild(celda);
        tbody.appendChild(fila);
    }
}

// Esta función se usa desde los botones de tareas
function filtrarTareas(tablaId, modo) {
    if (tablaId === "tablaTareas2A") {
        renderTablaTareas("2ºA", modo);
    } else {
        renderTablaTareas("2ºB", modo);
    }
}

// Actualizar tablas de notas según filtros
function actualizarNotas2A() {
    const trimestre = document.getElementById("filtroTrimestre2A").value;
    const area = document.getElementById("filtroArea2A").value;
    let alumnoFiltro = "";

    if (rolActual === "familia") {
        alumnoFiltro = (paraleloActual === "2ºA") ? alumnoActual : "";
    } else {
        alumnoFiltro = document.getElementById("filtroAlumno2A").value;
    }

    renderTablaNotas("tablaNotas2A", datosNotas2A, {
        alumno: alumnoFiltro,
        trimestre,
        area
    });
}

function actualizarNotas2B() {
    const trimestre = document.getElementById("filtroTrimestre2B").value;
    const area = document.getElementById("filtroArea2B").value;
    let alumnoFiltro = "";

    if (rolActual === "familia") {
        alumnoFiltro = (paraleloActual === "2ºB") ? alumnoActual : "";
    } else {
        alumnoFiltro = document.getElementById("filtroAlumno2B").value;
    }

    renderTablaNotas("tablaNotas2B", datosNotas2B, {
        alumno: alumnoFiltro,
        trimestre,
        area
    });
}

// Configurar vista para DOCENTE
function configurarVistaDocente() {
    const textoRol = document.getElementById("textoRol");
    const resumen = document.getElementById("resumenEstudiante");
    resumen.style.display = "none";

    textoRol.textContent = "Acceso: Docente / Administrador";

    document.getElementById("filtros2A").style.display = "flex";
    document.getElementById("filtros2B").style.display = "flex";

    document.getElementById("a-notas").style.display = "block";
    document.getElementById("b-notas").style.display = "block";
    document.getElementById("a-tareas").style.display = "block";
    document.getElementById("b-tareas").style.display = "block";
    document.getElementById("panel-docente").style.display = "block";
    document.getElementById("linkPanelDocente").style.display = "inline-block";

    document.getElementById("linkNotas2A").style.display = "inline-block";
    document.getElementById("linkNotas2B").style.display = "inline-block";
    document.getElementById("linkTareas2A").style.display = "inline-block";
    document.getElementById("linkTareas2B").style.display = "inline-block";

    // Reset filtros asistencia
    const diaSel = document.getElementById("selectDiaAsistencia");
    const parSel = document.getElementById("selectParaleloAsistencia");
    if (diaSel) diaSel.value = "";
    if (parSel) parSel.value = "";

    actualizarNotas2A();
    actualizarNotas2B();
    renderTablaAsistencia({});

    renderTablaTareas("2ºA", "todas");
    renderTablaTareas("2ºB", "todas");

    // Inicializar lista de alumnos en panel docente
    actualizarListaPanelAlumnos();
}

// Configurar vista para FAMILIA
function configurarVistaFamilia() {
    const textoRol = document.getElementById("textoRol");
    const resumen = document.getElementById("resumenEstudiante");

    textoRol.textContent = "Acceso: Madre, padre o tutor";
    resumen.style.display = "block";
    resumen.textContent = `Visualizando información de: ${alumnoActual} (${paraleloActual})`;

    document.getElementById("panel-docente").style.display = "none";
    document.getElementById("linkPanelDocente").style.display = "none";

    // Ocultamos selector de alumno, pero mantenemos trimestre/área
    const selectAlumno2A = document.getElementById("filtroAlumno2A");
    const selectAlumno2B = document.getElementById("filtroAlumno2B");
    if (selectAlumno2A) selectAlumno2A.style.display = "none";
    if (selectAlumno2B) selectAlumno2B.style.display = "none";

    if (paraleloActual === "2ºA") {
        document.getElementById("a-notas").style.display = "block";
        document.getElementById("b-notas").style.display = "none";
        document.getElementById("a-tareas").style.display = "block";
        document.getElementById("b-tareas").style.display = "none";

        document.getElementById("linkNotas2A").style.display = "inline-block";
        document.getElementById("linkNotas2B").style.display = "none";
        document.getElementById("linkTareas2A").style.display = "inline-block";
        document.getElementById("linkTareas2B").style.display = "none";

        actualizarNotas2A();
        renderTablaNotas("tablaNotas2B", datosNotas2B, { alumno: "" });

        renderTablaTareas("2ºA", "todas");
    } else {
        document.getElementById("a-notas").style.display = "none";
        document.getElementById("b-notas").style.display = "block";
        document.getElementById("a-tareas").style.display = "none";
        document.getElementById("b-tareas").style.display = "block";

        document.getElementById("linkNotas2A").style.display = "none";
        document.getElementById("linkNotas2B").style.display = "inline-block";
        document.getElementById("linkTareas2A").style.display = "none";
        document.getElementById("linkTareas2B").style.display = "inline-block";

        actualizarNotas2B();
        renderTablaNotas("tablaNotas2A", datosNotas2A, { alumno: "" });

        renderTablaTareas("2ºB", "todas");
    }

    // Para familias: asistencia solo del estudiante, pero puede filtrar por día
    const diaSel = document.getElementById("selectDiaAsistencia");
    if (diaSel) diaSel.value = "";
    renderTablaAsistencia({ nombre: alumnoActual });
}

// Manejo de acceso
document.getElementById("btnIngresar").addEventListener("click", () => {
    const codigo = document.getElementById("codigoAcceso").value.trim();
    const mensajeError = document.getElementById("mensajeError");
    const rolSeleccionado = document.querySelector('input[name="rol"]:checked').value;

    if (rolSeleccionado === "docente") {
        if (codigo !== CODIGO_DOCENTE) {
            mensajeError.textContent = "Código incorrecto. Verifique e intente nuevamente.";
            return;
        }
        rolActual = "docente";
        mensajeError.textContent = "";
        document.getElementById("pantalla-acceso").style.display = "none";
        document.getElementById("app").style.display = "block";
        configurarVistaDocente();
    } else {
        const codigoNorm = normalizarCodigoFamilia(codigo);
        const info = codigosFamilia[codigoNorm];
        if (!info) {
            mensajeError.textContent = "Código de estudiante no válido. Revise el primer apellido y nombre.";
            return;
        }
        rolActual = "familia";
        alumnoActual = info.alumno;
        paraleloActual = info.paralelo;
        mensajeError.textContent = "";
        document.getElementById("pantalla-acceso").style.display = "none";
        document.getElementById("app").style.display = "block";
        configurarVistaFamilia();
    }
});

// Mostrar/ocultar clave
document.getElementById("toggleVerClave").addEventListener("change", (e) => {
    const input = document.getElementById("codigoAcceso");
    input.type = e.target.checked ? "text" : "password";
});

// Panel docente: lista de alumnos según paralelo
function actualizarListaPanelAlumnos() {
    const paralelo = document.getElementById("panelParalelo").value;
    const select = document.getElementById("panelAlumno");
    const datos = paralelo === "2ºA" ? datosNotas2A : datosNotas2B;

    select.innerHTML = "";
    obtenerListaAlumnos(datos).forEach(nombre => {
        const opt = document.createElement("option");
        opt.value = nombre;
        opt.textContent = nombre;
        select.appendChild(opt);
    });
}

// Panel docente: guardar/actualizar nota (Ser, Saber, Hacer, Decidir, Autoevaluación)
function guardarNotaDesdePanel() {
    const paralelo = document.getElementById("panelParalelo").value;
    const alumno = document.getElementById("panelAlumno").value;
    const trimestre = document.getElementById("panelTrimestre").value;
    const area = document.getElementById("panelArea").value;

    const serStr = document.getElementById("panelSer").value.trim();
    const saberStr = document.getElementById("panelSaber").value.trim();
    const hacerStr = document.getElementById("panelHacer").value.trim();
    const decidirStr = document.getElementById("panelDecidir").value.trim();
    const autoStr = document.getElementById("panelAutoeval").value.trim();

    if (!alumno || !trimestre || !area || !serStr || !saberStr || !hacerStr || !decidirStr || !autoStr) {
        alert("Complete paralelo, estudiante, trimestre, área y las cinco notas (Ser, Saber, Hacer, Decidir, Autoevaluación).");
        return;
    }

    const ser = Number(serStr);
    const saber = Number(saberStr);
    const hacer = Number(hacerStr);
    const decidir = Number(decidirStr);
    const autoeval = Number(autoStr);

    const rangosValidos =
        ser >= 0 && ser <= 5 &&
        saber >= 0 && saber <= 45 &&
        hacer >= 0 && hacer <= 40 &&
        decidir >= 0 && decidir <= 5 &&
        autoeval >= 0 && autoeval <= 5;

    if (!rangosValidos) {
        alert("Verifique que cada nota esté dentro de su rango permitido.");
        return;
    }

    const notaFinal = ser + saber + hacer + decidir + autoeval;
    const obs = generarObservacion(notaFinal, area);

    const arreglo = paralelo === "2ºA" ? datosNotas2A : datosNotas2B;

    // Buscar si ya existe registro para ese alumno+trimestre+área
    const existente = arreglo.find(reg =>
        reg.alumno === alumno &&
        reg.trimestre === trimestre &&
        reg.area === area
    );

    if (existente) {
        existente.ser = ser;
        existente.saber = saber;
        existente.hacer = hacer;
        existente.decidir = decidir;
        existente.autoeval = autoeval;
        existente.nota = notaFinal;
        existente.obs = obs;
    } else {
        arreglo.push({
            alumno,
            area,
            trimestre,
            ser,
            saber,
            hacer,
            decidir,
            autoeval,
            nota: notaFinal,
            obs
        });
    }

    // Refrescar tablas
    actualizarNotas2A();
    actualizarNotas2B();

    alert(`Nota registrada/actualizada. Promedio final: ${notaFinal}`);
}

// Panel docente: descargar JSON con notas, asistencia y tareas
function descargarJSONDatos() {
    const datos = {
        notas2A: datosNotas2A,
        notas2B: datosNotas2B,
        asistencia: datosAsistencia,
        tareas2A: tareas2A,
        tareas2B: tareas2B,
        estadoTareas2A: estadoTareas2A,
        estadoTareas2B: estadoTareas2B
    };

    const contenido = JSON.stringify(datos, null, 2);
    const blob = new Blob([contenido], { type: "application/json" });

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");

    const hoy = new Date();
    const yyyy = hoy.getFullYear();
    const mm = String(hoy.getMonth() + 1).padStart(2, "0");
    const dd = String(hoy.getDate()).padStart(2, "0");
    const nombreArchivo = `sanpiox-datos-${yyyy}-${mm}-${dd}.json`;

    a.href = url;
    a.download = nombreArchivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Descargar CSV genérico
function descargarCSV(datos, nombreArchivo) {
    if (!datos || datos.length === 0) {
        alert(`No hay datos para ${nombreArchivo}`);
        return;
    }

    const filas = [];
    const encabezados = Object.keys(datos[0]);
    filas.push(encabezados.join(","));

    datos.forEach(obj => {
        const fila = encabezados.map(k => {
            const valor = obj[k] ?? "";
            // Escapar comillas y separar por comas
            return `"${String(valor).replace(/"/g, '""')}"`;
        }).join(",");
        filas.push(fila);
    });

    const contenido = filas.join("\n");
    const blob = new Blob([contenido], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = nombreArchivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Guardar datos en localStorage
function guardarDatosLocal() {
    const datos = {
        notas2A: datosNotas2A,
        notas2B: datosNotas2B,
        asistencia: datosAsistencia,
        estadoTareas2A: estadoTareas2A,
        estadoTareas2B: estadoTareas2B
    };
    localStorage.setItem("sanpiox_datos", JSON.stringify(datos));
    alert("Datos guardados correctamente en esta computadora (navegador actual).");
}

// Cargar datos desde localStorage
function cargarDatosLocal() {
    const datosGuardados = localStorage.getItem("sanpiox_datos");
    if (!datosGuardados) {
        alert("No hay datos guardados en esta computadora.");
        return;
    }
    const datos = JSON.parse(datosGuardados);

    // Restaurar cada arreglo (vaciando y llenando)
    datosNotas2A.length = 0;
    datosNotas2A.push(...(datos.notas2A || []));

    datosNotas2B.length = 0;
    datosNotas2B.push(...(datos.notas2B || []));

    datosAsistencia.length = 0;
    datosAsistencia.push(...(datos.asistencia || []));

    estadoTareas2A.length = 0;
    estadoTareas2A.push(...(datos.estadoTareas2A || []));

    estadoTareas2B.length = 0;
    estadoTareas2B.push(...(datos.estadoTareas2B || []));

    // Refrescar vistas según rol
    if (rolActual === "docente") {
        actualizarNotas2A();
        actualizarNotas2B();
        renderTablaAsistencia({});
        renderTablaTareas("2ºA", "todas");
        renderTablaTareas("2ºB", "todas");
    } else if (rolActual === "familia") {
        if (paraleloActual === "2ºA") {
            actualizarNotas2A();
            renderTablaTareas("2ºA", "todas");
        } else if (paraleloActual === "2ºB") {
            actualizarNotas2B();
            renderTablaTareas("2ºB", "todas");
        }
        renderTablaAsistencia({ nombre: alumnoActual });
    }

    alert("Datos cargados correctamente desde la computadora.");
}

// Inicialización
document.addEventListener("DOMContentLoaded", () => {
    // Inicializar asistencia (lunes a viernes)
    inicializarAsistenciaSemana();

    // Selectores de alumnos para notas (modo docente)
    llenarSelectAlumnos("filtroAlumno2A", datosNotas2A);
    llenarSelectAlumnos("filtroAlumno2B", datosNotas2B);

    // Llenar select de días para asistencia
    const selDia = document.getElementById("selectDiaAsistencia");
    if (selDia) {
        const optTodos = document.createElement("option");
        optTodos.value = "";
        optTodos.textContent = "Todos";
        selDia.appendChild(optTodos);

        diasSemana.forEach(dia => {
            const opt = document.createElement("option");
            opt.value = dia;
            opt.textContent = dia;
            selDia.appendChild(opt);
        });

        selDia.addEventListener("change", () => {
            const dia = selDia.value || undefined;
            const parSel = document.getElementById("selectParaleloAsistencia");
            const paralelo = parSel ? (parSel.value || undefined) : undefined;

            if (rolActual === "docente") {
                renderTablaAsistencia({ dia, paralelo });
            } else if (rolActual === "familia") {
                renderTablaAsistencia({ nombre: alumnoActual, dia, paralelo: paraleloActual });
            }
        });
    }

    const selPar = document.getElementById("selectParaleloAsistencia");
    if (selPar) {
        selPar.addEventListener("change", () => {
            const par = selPar.value || undefined;
            const diaSel = document.getElementById("selectDiaAsistencia");
            const dia = diaSel ? (diaSel.value || undefined) : undefined;

            if (rolActual === "docente") {
                renderTablaAsistencia({ dia, paralelo: par });
            } else if (rolActual === "familia") {
                renderTablaAsistencia({ nombre: alumnoActual, dia, paralelo: paraleloActual });
            }
        });
    }

    // Listeners filtros notas 2ºA
    document.getElementById("filtroAlumno2A").addEventListener("change", actualizarNotas2A);
    document.getElementById("filtroTrimestre2A").addEventListener("change", actualizarNotas2A);
    document.getElementById("filtroArea2A").addEventListener("change", actualizarNotas2A);

    // Listeners filtros notas 2ºB
    document.getElementById("filtroAlumno2B").addEventListener("change", actualizarNotas2B);
    document.getElementById("filtroTrimestre2B").addEventListener("change", actualizarNotas2B);
    document.getElementById("filtroArea2B").addEventListener("change", actualizarNotas2B);

    // Botones tareas recientes / todas
    document.querySelectorAll(".btn-tareas").forEach(btn => {
        btn.addEventListener("click", () => {
            const tablaId = btn.dataset.target;
            const modo = btn.dataset.modo;
            filtrarTareas(tablaId, modo);
        });
    });

    // Panel docente: cambio de paralelo actualiza lista de alumnos
    document.getElementById("panelParalelo").addEventListener("change", actualizarListaPanelAlumnos);
    document.getElementById("btnGuardarNota").addEventListener("click", guardarNotaDesdePanel);
    document.getElementById("btnDescargarJSON").addEventListener("click", descargarJSONDatos);
    document.getElementById("btnDescargarCSV").addEventListener("click", () => {
        descargarCSV(datosNotas2A, "notas_2A.csv");
        descargarCSV(datosNotas2B, "notas_2B.csv");
        descargarCSV(datosAsistencia, "asistencia.csv");
        descargarCSV(estadoTareas2A, "tareas_2A.csv");
        descargarCSV(estadoTareas2B, "tareas_2B.csv");
        alert("Se han descargado los archivos CSV (notas, asistencia y tareas).");
    });
    document.getElementById("btnGuardarLocal").addEventListener("click", guardarDatosLocal);
    document.getElementById("btnCargarLocal").addEventListener("click", cargarDatosLocal);

    // Inicial: tablas base (aunque no visibles hasta ingresar)
    renderTablaNotas("tablaNotas2A", datosNotas2A, {});
    renderTablaNotas("tablaNotas2B", datosNotas2B, {});
    renderTablaAsistencia({});

    renderTablaTareas("2ºA", "todas");
    renderTablaTareas("2ºB", "todas");

    // Inicializar lista de alumnos del panel (por defecto 2ºA)
    actualizarListaPanelAlumnos();
});
</script>

</body>
</html>
